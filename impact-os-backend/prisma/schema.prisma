// Impact OS Database Schema
// Behavioral Operating System for Economic Transformation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// APPLICANT & INTAKE
// ============================================================================

model Applicant {
  id                   String          @id @default(cuid())
  
  // === SECTION 1: IDENTITY ===
  firstName            String          @db.VarChar(25)
  lastName             String          @db.VarChar(25)
  whatsapp             String
  email                String          @unique
  age                  Int
  country              String          @default("Nigeria")
  state                String?
  gender               Gender
  source               LeadSource      @default(WEBSITE)
  
  // === SECTION 2: CURRENT SITUATION ===
  currentStatus        CurrentStatus?
  educationLevel       EducationLevel?
  biggestChallenge     String?         @db.VarChar(150)
  
  // === SECTION 3: RESOURCE CHECK ===
  hasInternet          InternetAccess?
  weeklyHours          WeeklyHours?
  primaryDevice        DeviceType?
  
  // === SECTION 4: SKILL INTEREST ===
  skillTrack           SkillTrack?
  triedOnlineEarning   Boolean?
  onlineEarningOutcome String?         @db.VarChar(200)
  triedLearningSkill   Boolean?
  
  // === SECTION 5: DIAGNOSTIC PROBES ===
  technicalProbe       String?         @db.VarChar(300)
  commercialProbe      String?         @db.VarChar(300)
  exposureProbe        String?         @db.VarChar(300)
  commitmentProbe      String?         @db.VarChar(300)
  
  // === SECTION 6: CONSENT ===
  consentDailyAction   Boolean         @default(false)
  consentWeeklyCheckin Boolean         @default(false)
  consentFailure       Boolean         @default(false)
  consentData          Boolean         @default(false)
  
  // === AI DIAGNOSIS ===
  readinessScore       Float?
  actionOrientation    Float?
  marketAwareness      Float?
  rejectionResilience  Float?
  commitmentSignal     Float?
  diagnosticReport     Json?
  riskFlags            String[]
  aiRecommendation     String?
  
  // === DECISION ===
  status               ApplicantStatus @default(STARTED)
  rejectionReason      RejectionReason?
  reviewedBy           String?
  reviewedAt           DateTime?
  
  // === TRACKING ===
  completedSections    Int             @default(0)
  lastSectionAt        DateTime?
  startedAt            DateTime        @default(now())
  submittedAt          DateTime?
  convertedAt          DateTime?
  
  // === RESUME FLOW ===
  resumeToken          String?         @unique
  resumeTokenExpiresAt DateTime?
  resumeEmailSent      Boolean         @default(false)
  
  // === OFFER TOKEN ===
  offerToken           String?         @unique  // For accept/decline links
  offerTokenExpiresAt  DateTime?
  // === ATTRIBUTION ===
  deviceDetected       String?
  utmSource            String?
  utmMedium            String?
  utmCampaign          String?
  referralCode         String?
  
  // === RELATIONS ===
  cohortId             String?
  cohort               Cohort?         @relation(fields: [cohortId], references: [id])
  user                 User?
  conditionalTasks     ConditionalTask[]
  
  // === INCOME CONTEXT ===
  incomeRange          IncomeRange?         // Dropdown selection
  intakeIncomeSource   IntakeIncomeSource?  // How they earn (intake context)
  
  // === SKILL TRIAD (computed from probes) ===
  triadTechnical       Float?          // 0-100
  triadSoft            Float?          // 0-100
  triadCommercial      Float?          // 0-100
  
  // === OFFER DECISION ===
  offerType            OfferType?
  receivesStipend      Boolean         @default(false)
  primaryFocus         SkillDomain?
  kpiTargets           Json?           // { weeklyXp, weeklyArena, incomeTarget, graduationDay }
  
  // === PSN FORECAST (Admin-Only) ===
  psnLevel             PsnLevel?
  psnScore             Float?          // 0-100 internal score
  psnConfidence        Float?          // 0.0-1.0
  psnPrimaryConstraint PsnConstraint?
  psnGeneratedAt       DateTime?
  
  @@index([status])
  @@index([email])
  @@index([source])
}

model ConditionalTask {
  id          String              @id @default(cuid())
  applicantId String
  applicant   Applicant           @relation(fields: [applicantId], references: [id])
  
  type        ConditionalTaskType
  completed   Boolean             @default(false)
  proofUrl    String?
  submittedAt DateTime?
  deadline    DateTime
  
  createdAt   DateTime            @default(now())
}

// ============================================================================
// USER & IDENTITY
// ============================================================================

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  whatsapp        String?
  firstName       String
  lastName        String
  
  // Identity Level (L0-L5)
  identityLevel   IdentityLevel @default(L1_ACTIVATED)
  
  // Program Phase (for phase-gating support)
  currentPhase    ProgramPhase  @default(ONBOARDING)
  
  // Onboarding
  applicantId     String?       @unique
  applicant       Applicant?    @relation(fields: [applicantId], references: [id])
  
  // Cohort
  cohortId        String?
  cohort          Cohort?       @relation(fields: [cohortId], references: [id])
  
  // Profile
  skillTrack      SkillTrack?
  avatarUrl       String?
  bio             String?
  
  // Social Handles (for The Wall)
  instagramHandle String?
  twitterHandle   String?
  linkedinUrl     String?
  
  // Streak Tracking
  currentStreak   Int           @default(0)
  lastCheckIn     DateTime?
  
  // Authentication
  username        String?       @unique  // Generated from firstName.lastName
  pin             String?       // 4-digit PIN set during offer acceptance
  otpCode         String?
  otpExpiresAt    DateTime?
  lastLoginAt     DateTime?
  
  // Status
  isActive        Boolean       @default(true)
  pausedAt        DateTime?
  pauseReason     String?
  
  // Command Centre (Participant State Authority)
  participantState ParticipantState @default(ACTIVE)
  graduatedAt      DateTime?
  exitedAt         DateTime?
  
  // Support Cooldown
  supportCooldownUntil DateTime?  // When cooldown expires for next request
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  currencyLedger      CurrencyLedger[]
  missions            MissionAssignment[]
  incomeRecords       IncomeRecord[]
  checkIns            CheckIn[]
  failures            FailureRecord[]
  supportWallet       SupportWallet?
  supportRequests     SupportRequest[]
  staff               Staff?
  triadScore          SkillTriadScore?
  behaviorLogs        BehaviorLog[]
  wallPosts           WallPost[]
  interventionAlerts  InterventionAlert[]
  participantStateLogs ParticipantStateLog[]
  gateEvaluations     GateEvaluation[]
  
  @@index([email])
  @@index([identityLevel])
  @@index([participantState])
}

// ============================================================================
// STAFF MANAGEMENT
// ============================================================================

model Staff {
  id              String          @id @default(cuid())
  userId          String          @unique
  user            User            @relation(fields: [userId], references: [id])
  
  category        StaffCategory   // ADMIN, STAFF, OBSERVER
  isSuperAdmin    Boolean         @default(false)
  
  capabilities    String[]        // Array of capability keys
  notificationPrefs String[]      // Which notifications to receive: testimonials, partners, applications, income, support, critical
  
  // Scope assignments
  cohortIds       String[]        // Assigned cohorts
  queueIds        String[]        // Assigned queues (support, income, mentor)
  participantIds  String[]        // Assigned participants (for 1:1 mentors)
  
  // Invite flow
  inviteToken         String?     @unique
  inviteTokenExpiresAt DateTime?
  setupCompleted      Boolean     @default(false)
  
  // Audit
  invitedBy       String
  invitedAt       DateTime        @default(now())
  isActive        Boolean         @default(true)
  deactivatedAt   DateTime?
  
  @@index([category])
  @@index([userId])
  @@index([inviteToken])
}

model Cohort {
  id            String      @id @default(cuid())
  name          String      // e.g., "Cohort 2026-Q1"
  startDate     DateTime
  endDate       DateTime?
  capacity      Int         @default(50)
  
  isActive      Boolean     @default(true)
  
  // Command Centre (Calendar Engine)
  currentPhase    CohortPhase  @default(PRE_COHORT)
  currentDay      Int          @default(0)       // Program day (1-90, 0 = pre-cohort)
  timezone        String       @default("Africa/Lagos")
  orientationDate DateTime?    // Day before program start
  
  applicants    Applicant[]
  users         User[]
  config        CohortConfig?
  commitmentAllocations CommitmentAllocation[]
  psnForecast   CohortPsnForecast?
  calendarEvents CalendarEvent[]
  gateEvaluations GateEvaluation[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([currentPhase])
}

// ============================================================================
// PHASE CONFIGURATION (Dynamic, Admin-Managed)
// ============================================================================

model Phase {
  id            String   @id @default(cuid())
  name          String   // e.g., "Week 1", "Onboarding"
  slug          String   @unique // e.g., "WEEK_1", "ONBOARDING"
  order         Int      // Display/progression order
  durationDays  Int      @default(7)
  description   String?
  
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([order])
}

// ============================================================================
// CALENDAR EVENTS (Program Schedule)
// ============================================================================

model CalendarEvent {
  id          String            @id @default(cuid())
  title       String
  date        DateTime
  time        String?           // e.g., "10:00"
  type        CalendarEventType
  description String?
  
  cohortId    String?
  cohort      Cohort?           @relation(fields: [cohortId], references: [id])
  
  createdBy   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([date])
  @@index([cohortId])
}

enum CalendarEventType {
  ORIENTATION
  DEADLINE
  MILESTONE
  SESSION
  OTHER
}

// ============================================================================
// PROGRAM CONFIGURATION (Singleton)
// ============================================================================

model ProgramConfig {
  id                        String   @id @default("default")
  programName               String   @default("Cycle 28")
  organizationName          String   @default("Project 3:10")
  supportEmail              String   @default("support@cycle28.org")
  dashboardUrl              String?
  
  // Authentication
  otpExpiryMinutes          Int      @default(10)
  allowSelfSignup           Boolean  @default(false)
  
  // Program Rules
  requireOrientation        Boolean  @default(true)
  maxApplicationsPerCohort  Int      @default(50)
  
  // Support System
  supportRequestTTLDays     Int      @default(30)
  autoExpireSupportRequests Boolean  @default(true)
  
  updatedAt                 DateTime @updatedAt
}

// ============================================================================
// COHORT CONFIGURATION (Admin Managed)
// ============================================================================

model CohortConfig {
  id                    String      @id @default(cuid())
  cohortId              String      @unique
  cohort                Cohort      @relation(fields: [cohortId], references: [id])
  
  // Application Status
  applicationsOpen      Boolean     @default(true)
  openDate              DateTime?   // When applications open (for countdown)
  closeDate             DateTime?   // When applications close
  
  // Disabled Skill Tracks (JSON array of track names)
  disabledTracks        String[]    // e.g., ["MUSIC_PRODUCTION", "VIDEO_PRODUCTION"]
  
  // Founder Success Message
  founderMessageTitle   String      @default("Welcome to the Journey!")
  founderMessageBody    String      @db.Text @default("I'm so excited to have you join us. You've taken the first step toward transforming your future. Check your email for next steps, and remember: every expert was once a beginner.")
  founderName           String      @default("Pope")
  founderImageUrl       String?     // Path to Pope.png
  founderSignatureUrl   String?     // Path to sig.png
  
  // Notification Settings
  waitlistEnabled       Boolean     @default(true)
  
  updatedAt             DateTime    @updatedAt
  updatedBy             String?     // Admin who last updated
}

// ============================================================================
// PSN FORECASTING & DETECTION
// ============================================================================

// Cohort-level PSN forecast for operational planning
model CohortPsnForecast {
  id                          String    @id @default(cuid())
  cohortId                    String    @unique
  cohort                      Cohort    @relation(fields: [cohortId], references: [id])
  
  countHigh                   Int
  countMedium                 Int
  countLow                    Int
  
  predictedDemandExpected     Float
  predictedDemandUpper        Float
  predictedDemandLower        Float
  
  riskBadge                   RiskBadge
  generatedAt                 DateTime  @default(now())
}

// Audit log for PSN calculations (immutable)
model PsnCalculationLog {
  id              String   @id @default(cuid())
  applicantId     String
  version         String   // e.g., "v1.0-deterministic"
  inputHash       String   // Hash of inputs for reproducibility
  output          Json     // Full PSN output
  createdAt       DateTime @default(now())
  
  @@index([applicantId])
}

// Proactive blocker detection events
model DetectionTrigger {
  id              String    @id @default(cuid())
  participantId   String
  signalType      String    // e.g., "MISSION_STALL", "MOMENTUM_DROP", "LOGIN_GAP"
  severity        DetectionSeverity
  actionTaken     DetectionAction
  details         Json?     // Additional context
  resolvedAt      DateTime?
  createdAt       DateTime  @default(now())
  
  @@index([participantId, createdAt])
}

// ============================================================================
// COMMAND CENTRE (Gates, State Authority, Audit)
// ============================================================================

// Gate Evaluation Record (Immutable)
model GateEvaluation {
  id              String      @id @default(cuid())
  cohortId        String
  cohort          Cohort      @relation(fields: [cohortId], references: [id])
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  gateType        GateType
  dayNumber       Int         // Actual day when executed
  
  result          GateResult
  evaluationData  Json        // Inputs used for evaluation (immutable snapshot)
  
  executedAt      DateTime    @default(now())
  
  @@index([cohortId, gateType])
  @@index([userId, gateType])
  @@index([result])
}

// Participant State Log (Immutable Audit Trail)
model ParticipantStateLog {
  id               String           @id @default(cuid())
  userId           String
  user             User             @relation(fields: [userId], references: [id])
  
  fromState        ParticipantState
  toState          ParticipantState
  reason           String           @db.VarChar(500)
  triggeredBy      String           // "SYSTEM" or staffId
  gateEvaluationId String?          // If triggered by a gate
  
  createdAt        DateTime         @default(now())
  
  @@index([userId, createdAt])
}

// Command Audit Log (Override Tracking - ADMIN only)
model CommandAuditLog {
  id              String      @id @default(cuid())
  action          String      // "OVERRIDE_GATE", "FORCE_GRADUATE", "MANUAL_PAUSE", etc.
  targetId        String      // userId or cohortId
  targetType      String      // "USER", "COHORT"
  reason          String      @db.VarChar(500)
  performedBy     String      // Staff userId (ADMIN only)
  previousValue   Json?
  newValue        Json?
  
  createdAt       DateTime    @default(now())
  
  @@index([targetId, targetType])
  @@index([performedBy])
  @@index([createdAt])
}

// ============================================================================
// CURRENCY SYSTEM
// ============================================================================

model CurrencyLedger {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  
  currencyType  CurrencyType
  amount        Int
  reason        String
  missionId     String?
  
  createdAt     DateTime      @default(now())
  
  @@index([userId, currencyType])
}

// ============================================================================
// SUPPORT WALLET SYSTEM
// ============================================================================

// Participant's budget allocation - invisible to participant
model SupportWallet {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id])
  
  allocatedBudget   Float     // MSA - set at cohort start (e.g., $100)
  totalSpent        Float     @default(0)
  
  // Bank details for cash transfers (Paystack verified)
  bankCode          String?
  accountNumber     String?
  accountName       String?   // Resolved via Paystack
  verifiedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// Support request from participant
model SupportRequest {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id])
  
  type            SupportType
  missionId       String?             // Which mission this enables
  justification   String              @db.VarChar(200)
  evidence        String?             // URL to uploaded proof
  
  status          SupportRequestStatus @default(PENDING)
  approvalTier    ApprovalTier?
  approverId      String?             // Admin who approved (or "SYSTEM")
  
  // Denial handling (strict enforcement)
  denialReasonCode SupportDenialReason?  // Required for DENIED status
  reasonCode      String?                // Legacy: free-text reason (deprecated)
  
  // Internal amount (never shown to participant)
  amount          Float?
  
  // Expiration (72h after approval)
  expiresAt       DateTime?
  
  disbursements   DisbursementLog[]
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  @@index([userId, status])
}

// Audit log for all disbursements - immutable
model DisbursementLog {
  id              String              @id @default(cuid())
  requestId       String
  request         SupportRequest      @relation(fields: [requestId], references: [id])
  userId          String
  cohortId        String?
  
  type            DisbursementType
  amount          Float
  status          DisbursementStatus  @default(PENDING)
  
  // Provider details
  providerRef     String?             // Paystack/telco reference
  providerStatus  String?             // Raw status from provider
  
  createdAt       DateTime            @default(now())
  completedAt     DateTime?
  
  @@index([userId])
  @@index([status])
}

enum SupportType {
  DATA
  TRANSPORT
  TOOLS
  COUNSELLING
  CASH
}

enum SupportRequestStatus {
  PENDING
  APPROVED
  APPROVED_PENDING_DISBURSE  // Approved but awaiting fund release
  DENIED
  COMPLETED
  EXPIRED                     // Auto-expired after timeout
}

enum ApprovalTier {
  AUTO        // System auto-approved
  OPERATOR    // Operator approved
  ADMIN       // Admin escalation
}

enum DisbursementType {
  DATA_TOPUP
  VOUCHER
  TOOL_ACCESS
  CASH_TRANSFER
}

enum DisbursementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// SUPPORT DENIAL REASON CODES (Strict Enforcement)
// ============================================================================

enum SupportDenialReason {
  INSUFFICIENT_MOMENTUM     // Momentum < 50
  NO_ACTIVE_MISSION         // No mission in progress
  PHASE_MISMATCH            // Request doesn't match program phase
  COOLDOWN_ACTIVE           // Recent request still in cooldown
  BEHAVIORAL_FLAG           // Inactivity or avoidance detected
  BUDGET_EXHAUSTED          // Wallet budget depleted
  DUPLICATE_REQUEST         // Similar request already pending
  MANUAL_ADMIN_DECISION     // Admin discretionary denial
}

// ============================================================================
// PROGRAM PHASE (Phase-Gating)
// ============================================================================

enum ProgramPhase {
  ONBOARDING                // L1: Orientation
  SKILL_BUILDING            // L2: Learning missions
  MARKET_EXPOSURE           // L3: Outreach/Arena
  INCOME_GENERATION         // L4: Earning focus
  CATALYST                  // L5: Graduated
}

// ============================================================================
// MISSION SYSTEM
// ============================================================================

model Mission {
  id            String          @id @default(cuid())
  title         String
  description   String
  
  skillDomain   SkillDomain
  difficulty    Difficulty
  
  // Rewards
  momentum      Int             @default(0)
  skillXp       Int             @default(0)
  arenaPoints   Int             @default(0)
  
  // Requirements
  requiredLevel IdentityLevel   @default(L1_ACTIVATED)
  isDaily       Boolean         @default(false)
  isWeekly      Boolean         @default(false)
  
  isActive      Boolean         @default(true)
  
  assignments   MissionAssignment[]
  
  createdAt     DateTime        @default(now())
}

model MissionAssignment {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id])
  missionId       String
  mission         Mission             @relation(fields: [missionId], references: [id])
  
  status          MissionStatus       @default(ASSIGNED)
  proofUrl        String?
  proofText       String?             @db.VarChar(500)
  reflectionText  String?             @db.VarChar(150)
  
  // Timing
  assignedAt      DateTime            @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  deadlineAt      DateTime?
  expiresAt       DateTime?           // Auto-expiry for enforcement
  
  // Behavioral signals
  responseTimeMs  Int?                // Time from assigned to completed
  
  @@index([userId, status])
}

// ============================================================================
// FAILURE TRACKING
// ============================================================================

model FailureRecord {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  
  failureType   FailureType
  context       String?
  missionId     String?
  
  // AI Classification
  aiClassified  Boolean       @default(false)
  severity      Int?          // 1-5
  
  createdAt     DateTime      @default(now())
  
  @@index([userId, failureType])
}

// ============================================================================
// INCOME VERIFICATION
// ============================================================================

model IncomeRecord {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id])
  
  amount          Decimal
  currency        String              @default("NGN")
  amountUSD       Decimal?
  
  source          IncomeSource
  platform        String?
  clientName      String?
  description     String
  
  proofUrl        String
  proofType       ProofType
  
  status          VerificationStatus  @default(SUBMITTED)
  verifiedBy      String?
  verifiedAt      DateTime?
  rejectionReason String?
  
  earnedAt        DateTime
  submittedAt     DateTime            @default(now())
  
  @@index([userId, status])
}

// ============================================================================
// CHECK-INS
// ============================================================================

model CheckIn {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  
  type          CheckInType
  mood          Int?          // 1-5
  note          String?
  
  createdAt     DateTime      @default(now())
  
  @@index([userId, createdAt])
}

// ============================================================================
// SKILL TRIAD SCORE
// ============================================================================

model SkillTriadScore {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  
  technical   Int      @default(0)  // 0-100
  soft        Int      @default(0)  // 0-100
  commercial  Int      @default(0)  // 0-100
  
  updatedAt   DateTime @updatedAt
}

// ============================================================================
// INTERVENTION ALERTS
// ============================================================================

model InterventionAlert {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  type        AlertType
  severity    AlertSeverity @default(MEDIUM)
  message     String?       @db.VarChar(200)
  
  triggeredAt DateTime      @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?
  notes       String?       @db.VarChar(500)
  
  @@index([userId, type])
  @@index([resolvedAt])
}

enum AlertType {
  LOW_MOMENTUM
  MISSED_MISSIONS
  INACTIVE_7_DAYS
  TRIAD_IMBALANCE
  GRADUATION_BLOCK
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// BEHAVIOR LOG
// ============================================================================

model BehaviorLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  eventType   String   // CHECKIN, MISSION_COMPLETE, OUTREACH, etc.
  eventData   Json?    // Flexible payload
  
  timestamp   DateTime @default(now())
  
  @@index([userId, eventType])
  @@index([timestamp])
}

// ============================================================================
// THE WALL (Public Story Feed)
// ============================================================================

model WallPost {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  
  platform    Platform
  caption     String      @db.VarChar(500)
  postUrl     String?     @db.VarChar(200)
  usedHashtag Boolean     @default(false)
  
  // Auto-publish (no approval needed)
  status      WallPostStatus @default(PUBLISHED)
  flaggedAt   DateTime?
  flaggedBy   String?
  
  // Auto-calculated rank score
  rankScore   Float       @default(0)
  
  // Consent
  canFeature  Boolean     @default(true)
  
  submittedAt DateTime    @default(now())
  
  @@index([status, rankScore])
}

enum Platform {
  WHATSAPP_STATUS
  INSTAGRAM
  FACEBOOK
  TWITTER_X
  LINKEDIN
  TIKTOK
  OTHER
}

enum WallPostStatus {
  PUBLISHED   // Default - live immediately
  REMOVED     // Admin flagged for removal
}

// ============================================================================
// TESTIMONIALS (Website Submissions)
// ============================================================================

model Testimonial {
  id            String              @id @default(cuid())
  
  // Submitter info
  name          String
  role          String
  company       String?
  location      String
  
  // Content
  quote         String              @db.Text
  skills        String[]
  imageKey      String?             // R2 object key (source of truth)
  imageUrl      String?             // Kept for backward compatibility
  
  // Moderation
  status        TestimonialStatus   @default(PENDING)
  approvedBy    String?
  approvedAt    DateTime?
  
  // Tracking
  submittedAt   DateTime            @default(now())
  displayOrder  Int?
  isFeatured    Boolean             @default(false)
  
  @@index([status])
}

// ============================================================================
// SPONSOR & PARTNER INQUIRIES
// ============================================================================

model SponsorInquiry {
  id                String            @id @default(cuid())
  
  // Contact info
  name              String
  email             String
  phone             String?
  organizationType  String?           // Individual, Corporate, NGO, Church
  
  // Interest
  interestType      SponsorType
  amountInterest    String?           // e.g., "50000", "150000", "custom"
  message           String?           @db.Text
  
  // Follow-up
  status            InquiryStatus     @default(NEW)
  assignedTo        String?
  notes             String?           @db.Text
  followedUpAt      DateTime?
  convertedAt       DateTime?
  
  createdAt         DateTime          @default(now())
  
  @@index([status])
  @@index([email])
}

model PartnerInquiry {
  id                String            @id @default(cuid())
  
  // Organization info
  organizationName  String
  contactName       String
  email             String
  phone             String?
  website           String?
  
  // Partnership details
  partnershipType   PartnerType
  description       String            @db.Text
  
  // Follow-up
  status            InquiryStatus     @default(NEW)
  assignedTo        String?
  notes             String?           @db.Text
  followedUpAt      DateTime?
  partnershipStartedAt DateTime?
  
  createdAt         DateTime          @default(now())
  
  @@index([status])
  @@index([email])
}

// ============================================================================
// PARTNER FUNDING SYSTEM
// ============================================================================

// Partner organization (approved from inquiry)
model Partner {
  id                String          @id @default(cuid())
  name              String
  slug              String          @unique
  
  // Status lifecycle
  status            PartnerStatus   @default(LEAD)
  approvedAt        DateTime?
  approvedBy        String?
  
  // Contact
  primaryEmail      String
  primaryPhone      String?
  website           String?
  
  // Internal
  internalNotes     String?         @db.Text
  riskFlags         String[]
  
  // Relations
  users             PartnerUser[]
  commitments       FundingCommitment[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([status])
}

// Partner login (OTP-based, like User)
model PartnerUser {
  id                String          @id @default(cuid())
  partnerId         String
  partner           Partner         @relation(fields: [partnerId], references: [id])
  
  email             String          @unique
  firstName         String
  lastName          String
  
  // OTP auth (same pattern as User)
  otpCode           String?
  otpExpiresAt      DateTime?
  lastLoginAt       DateTime?
  
  role              PartnerUserRole @default(VIEWER)
  isActive          Boolean         @default(true)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

// Funding commitment (core abstraction)
model FundingCommitment {
  id                String              @id @default(cuid())
  partnerId         String
  partner           Partner             @relation(fields: [partnerId], references: [id])
  
  type              CommitmentType
  amount            Float
  currency          String              @default("USD")
  cadence           CommitmentCadence?
  
  startDate         DateTime?
  endDate           DateTime?
  
  // Cohort preferences
  targetCohortSize  Int?
  targetRegion      String?
  
  status            CommitmentStatus    @default(SUBMITTED)
  approvedAt        DateTime?
  approvedBy        String?
  
  // Utilization
  totalAllocated    Float               @default(0)
  totalDisbursed    Float               @default(0)
  
  allocations       CommitmentAllocation[]
  ledger            FundingLedger[]
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([partnerId, status])
}

// Links commitment → cohort
model CommitmentAllocation {
  id                String            @id @default(cuid())
  commitmentId      String
  commitment        FundingCommitment @relation(fields: [commitmentId], references: [id])
  cohortId          String
  cohort            Cohort            @relation(fields: [cohortId], references: [id])
  
  amount            Float
  participantCount  Int?
  
  status            AllocationStatus  @default(PLANNED)
  releaseDate       DateTime?
  releasedBy        String?
  notes             String?
  
  createdAt         DateTime          @default(now())
  
  @@unique([commitmentId, cohortId])
}

// Immutable funding audit log
model FundingLedger {
  id                String            @id @default(cuid())
  commitmentId      String
  commitment        FundingCommitment @relation(fields: [commitmentId], references: [id])
  
  type              FundingLedgerType
  amount            Float
  cohortId          String?
  description       String
  reference         String?
  
  createdById       String
  createdAt         DateTime          @default(now())
  
  @@index([commitmentId])
}

// Partner reports (read-only)
model PartnerReport {
  id                String            @id @default(cuid())
  partnerId         String
  cohortId          String?
  
  type              PartnerReportType
  title             String
  content           Json
  
  isLocked          Boolean           @default(false)
  downloadUrl       String?
  
  createdAt         DateTime          @default(now())
}

// ============================================================================
// PARTNER ENUMS
// ============================================================================

enum PartnerStatus {
  LEAD
  QUALIFIED
  APPROVED
  ACTIVE
  PAUSED
  CHURNED
}

enum PartnerUserRole {
  ADMIN
  VIEWER
}

enum CommitmentType {
  RECURRING
  ONE_OFF
  COHORT_SPONSOR
  CAPACITY_POOL
  PLEDGE_PENDING
}

enum CommitmentCadence {
  MONTHLY
  QUARTERLY
  ANNUAL
}

enum CommitmentStatus {
  SUBMITTED
  APPROVED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum AllocationStatus {
  PLANNED
  RELEASED
  IN_PROGRESS
  COMPLETED
}

enum FundingLedgerType {
  COMMITMENT_CREATED
  ALLOCATION_RELEASED
  DISBURSEMENT
  ADJUSTMENT
  REFUND
}

enum PartnerReportType {
  COHORT_INTERIM
  COHORT_FINAL
  ANNUAL_IMPACT
  CUSTOM
}

// ============================================================================
// ENUMS
// ============================================================================

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_SAY
}

enum LeadSource {
  WEBSITE
  INSTAGRAM
  TIKTOK
  TWITTER
  WHATSAPP
  REFERRAL
  ALUMNI
  CHURCH
  SCHOOL
  EVENT
  RADIO_TV
  OTHER
}

enum CurrentStatus {
  UNEMPLOYED
  UNDEREMPLOYED
  STUDENT
  CAREGIVER
  BETWEEN_JOBS
  STRUGGLING_BUSINESS
}

enum IncomeRange {
  ZERO              // ₦0 - No income at all
  LOW               // ₦1 - ₦30,000
  MEDIUM            // ₦30,001 - ₦100,000
  HIGH              // ₦100,001+
}

enum IntakeIncomeSource {
  NONE              // No income source
  FREELANCE         // Gig work, online freelance
  EMPLOYMENT        // Formal job
  BUSINESS          // Own business
  FAMILY            // Supported by family
  OTHER             // Other sources
}

enum EducationLevel {
  SECONDARY
  OND_HND
  BACHELORS
  MASTERS_PLUS
  IN_SCHOOL
  NO_FORMAL
}

enum InternetAccess {
  YES
  NO
  SOMETIMES
}

enum WeeklyHours {
  UNDER_5
  FIVE_TO_TEN
  TEN_TO_TWENTY
  TWENTY_PLUS
}

enum DeviceType {
  PHONE
  LAPTOP
  SHARED_PHONE
  SHARED_LAPTOP
}

enum SkillTrack {
  GRAPHICS_DESIGN
  DIGITAL_MARKETING
  WEB_DESIGN
  VIDEO_PRODUCTION
  AI_FOR_BUSINESS
  MUSIC_PRODUCTION
  UNDECIDED
}

enum ApplicantStatus {
  STARTED
  PARTIAL
  PENDING
  SCORING
  SCORED      // AI assessment complete, awaiting admin decision
  ADMITTED
  CONDITIONAL
  REJECTED
  WAITLIST
  CONVERTED
  WITHDRAWN
}

enum RejectionReason {
  AGE_INELIGIBLE
  LOCATION_UNSUPPORTED
  LOW_READINESS
  INCOMPLETE_FORM
  DUPLICATE
  NO_DEVICE
  NO_INTERNET
  NO_CONSENT
  STAFF_DECISION
}

enum ConditionalTaskType {
  OUTREACH_PROOF
  WHY_STATEMENT
  TIME_AUDIT
  INTRO_QUIZ
}

enum IdentityLevel {
  L0_APPLICANT
  L1_ACTIVATED
  L2_SKILLED
  L3_EXPOSED
  L4_EARNER
  L5_CATALYST
}

enum CurrencyType {
  MOMENTUM
  SKILL_XP
  ARENA_POINTS
  INCOME_PROOF
}

enum SkillDomain {
  TECHNICAL
  SOFT
  COMMERCIAL
}

enum OfferType {
  FULL_SUPPORT      // Stipend + Training
  SKILLS_ONLY       // Training only, has income
  ACCELERATOR       // Market exposure focus
  CATALYST_TRACK    // Income verification focus
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum MissionStatus {
  ASSIGNED
  IN_PROGRESS
  SUBMITTED
  VERIFIED
  FAILED
  EXPIRED
}

enum FailureType {
  MARKET_REJECTION
  NON_RESPONSE
  OFFER_DECLINED
  MISSED_DEADLINE
  AVOIDANCE
  BURNOUT_DIP
}

enum IncomeSource {
  FREELANCE
  CLIENT_WORK
  RETAINER
  CONTENT_PAYMENT
}

enum ProofType {
  SCREENSHOT
  BANK_STATEMENT
  PLATFORM_EXPORT
  CLIENT_CONFIRMATION
}

enum VerificationStatus {
  SUBMITTED
  UNDER_REVIEW
  VERIFIED
  REJECTED
}

enum CheckInType {
  DAILY
  WEEKLY
}

// Website Submission Enums
enum TestimonialStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SponsorType {
  ONE_MONTH
  FULL_PROGRAM
  CUSTOM
  CORPORATE
}

enum PartnerType {
  TRAINING_PARTNER
  EMPLOYMENT_PARTNER
  VENUE_PARTNER
  CONTENT_PARTNER
  MEDIA_PARTNER
  CHURCH_PARTNER
  SCHOOL_PARTNER
  OTHER
}

enum InquiryStatus {
  NEW
  CONTACTED
  IN_DISCUSSION
  CONVERTED
  DECLINED
  UNRESPONSIVE
}

enum StaffCategory {
  ADMIN
  STAFF
  OBSERVER
}

// ============================================================================
// PSN ENUMS
// ============================================================================

enum PsnLevel {
  LOW
  MEDIUM
  HIGH
}

enum PsnConstraint {
  DATA
  TRANSPORT
  TOOLS
  OTHER
}

enum RiskBadge {
  GREEN
  AMBER
  RED
}

enum DetectionSeverity {
  LOW
  MEDIUM
  HIGH
}

enum DetectionAction {
  PROMPT       // Soft message to participant
  QUEUE        // Added to operator queue
  ALERT        // Admin alert triggered
}

// ============================================================================
// COMMAND CENTRE ENUMS
// ============================================================================

enum ParticipantState {
  ACTIVE         // Default - actively participating
  AT_RISK        // Flagged for intervention
  PAUSED         // Temporarily suspended
  EXITED         // Non-completion exit
  GRADUATED      // Successfully completed program
}

enum CohortPhase {
  PRE_COHORT     // Day -28 to 0 (Intake, Screening, Onboarding)
  TRAINING       // Day 1-42 (Technical & skill missions)
  MARKET         // Day 43-69 (Outreach & exposure)
  INCOME         // Day 70-90 (Income verification)
  EXIT           // Post Day 90 (Graduation or non-completion)
}

enum GateType {
  DAY_1_BASELINE         // Day 1: START / EXCLUDE
  DAY_30_SELLABLE_SKILL  // Day 30: PASS / INTERVENE
  DAY_60_MARKET_CONTACT  // Day 60: PASS / ESCALATE
  DAY_90_INCOME          // Day 90: GRADUATE / EXIT
}

enum GateResult {
  PASS                   // Gate passed successfully
  FAIL                   // Gate failed - action required
  INTERVENTION_REQUIRED  // Needs manual review
  PENDING                // Awaiting inputs
}

// ============================================================================
// RESOURCE LIBRARY
// ============================================================================

model Resource {
  id          String         @id @default(cuid())
  title       String
  author      String?
  description String?        @db.Text
  url         String         @unique
  type        ResourceType
  thumbnail   String?
  skillTracks SkillTrack[]
  tags        String[]
  
  status      ResourceStatus @default(PENDING)
  
  sourceId    String?
  source      ResourceSource? @relation(fields: [sourceId], references: [id])
  
  createdBy   String?
  createdAt   DateTime       @default(now())
  approvedAt  DateTime?
  approvedBy  String?
  
  viewCount   Int            @default(0)
  
  @@index([status])
  @@index([type])
}

model ResourceSource {
  id          String       @id @default(cuid())
  name        String
  type        SourceType
  url         String       // RSS feed URL or YouTube channel ID
  skillTrack  SkillTrack?
  isActive    Boolean      @default(true)
  lastFetched DateTime?
  
  resources   Resource[]
  
  createdAt   DateTime     @default(now())
}

enum ResourceType {
  BOOK
  ARTICLE
  VIDEO
  PODCAST
  BLOG
}

enum ResourceStatus {
  PENDING    // Awaiting admin review
  APPROVED   // Visible to all users
  REJECTED   // Hidden
}

enum SourceType {
  RSS_FEED
  YOUTUBE_CHANNEL
}

// ============================================================================
// STAFF ESCALATION
// ============================================================================

model Escalation {
  id            String            @id @default(cuid())
  type          EscalationType
  referenceId   String            // ID of supportRequest, user, etc.
  referenceType String            // "SUPPORT_REQUEST", "PARTICIPANT", etc.
  
  fromStaffId   String
  toStaffId     String
  
  reason        String            @db.VarChar(500)
  priority      EscalationPriority @default(NORMAL)
  status        EscalationStatus  @default(PENDING)
  
  resolution    String?           @db.VarChar(500)
  resolvedAt    DateTime?
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@index([fromStaffId])
  @@index([toStaffId])
  @@index([status])
  @@index([referenceId])
}

enum EscalationType {
  SUPPORT_REQUEST   // Support request needs higher approval
  PARTICIPANT_CASE  // Participant issue needs senior review
  APPROVAL_NEEDED   // General approval request
  DISPUTE           // Conflict or complaint
  OTHER
}

enum EscalationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum EscalationStatus {
  PENDING       // Awaiting review
  ACKNOWLEDGED  // Supervisor has seen it
  IN_PROGRESS   // Being worked on
  RESOLVED      // Closed with resolution
  DISMISSED     // Closed without action
}

// ============================================================================
// COMMUNICATION LOG (Email Audit Trail)
// ============================================================================

model CommunicationLog {
  id              String              @id @default(cuid())
  
  // Sender context
  triggeredBy     String              // "SYSTEM" or staff userId
  triggerSource   CommunicationSource // INTAKE, ADMISSION, AUTH, etc.
  
  // Template context
  templateType    String              // "application_received", "offer_email", etc.
  templateVersion Int                 @default(1)
  
  // Content snapshot (immutable)
  subject         String
  contentHash     String              // Hash of HTML for integrity
  contentPreview  String              @db.VarChar(200)  // First 200 chars plaintext
  
  // Recipient
  recipientEmail  String
  recipientName   String?
  recipientId     String?             // User/Applicant ID if known
  recipientType   RecipientType       // USER, APPLICANT, PARTNER, STAFF, EXTERNAL
  
  // Linked entity (for audit correlation)
  linkedEntityType String?            // "APPLICANT", "SUPPORT_REQUEST", "MISSION"
  linkedEntityId   String?
  
  // Delivery tracking
  status          DeliveryStatus      @default(QUEUED)
  resendId        String?             // Provider message ID
  sentAt          DateTime?
  deliveredAt     DateTime?
  failedAt        DateTime?
  failureReason   String?
  openedAt        DateTime?           // Future: webhook tracking
  
  createdAt       DateTime            @default(now())
  
  @@index([recipientEmail])
  @@index([templateType])
  @@index([triggerSource])
  @@index([status])
  @@index([linkedEntityType, linkedEntityId])
  @@index([createdAt])
}

model CommunicationTemplate {
  id          String              @id @default(cuid())
  name        String              // Human-readable name "Welcome Email"
  slug        String              @unique // URL-safe identifier "welcome_email"
  description String?             // What this template is for
  category    CommunicationSource // INTAKE, ADMISSION, etc.
  
  // Template content
  subject     String              // Subject with {{variable}} placeholders
  htmlContent String              @db.Text // HTML content with {{variable}} placeholders
  
  // Variable definitions
  variables   Json?               // Array of { name, description, required }
  
  // Approval workflow
  status      TemplateStatus      @default(DRAFT)
  approvedAt  DateTime?
  approvedBy  String?             // Staff userId who approved
  
  // Versioning - keep previous version for safety
  version     Int                 @default(1)
  previousHtml String?            @db.Text  // Last approved HTML (fallback)
  previousSubject String?         // Last approved subject
  
  // Flags
  isActive    Boolean             @default(true)
  isSystem    Boolean             @default(false) // System templates can't be deleted
  
  // Audit
  createdBy   String?             // Staff userId
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  @@index([category])
  @@index([status])
  @@index([isActive])
  @@index([slug])
}

enum TemplateStatus {
  DRAFT            // Initial creation, not yet approved
  PENDING_APPROVAL // Edited and awaiting approval
  APPROVED         // Ready for use
  DEPRECATED       // No longer in use
}

enum CommunicationSource {
  INTAKE          // Application flow
  ADMISSION       // Offers, decisions
  AUTH            // OTP, login
  STAFF           // Staff invites
  SUPPORT         // Support request updates
  MISSION         // Mission reminders
  BROADCAST       // Manual broadcast
  SYSTEM          // Automated system emails
}

enum RecipientType {
  USER
  APPLICANT
  PARTNER
  STAFF
  EXTERNAL
}

enum DeliveryStatus {
  QUEUED
  SENT
  DELIVERED
  BOUNCED
  FAILED
}
